name: Kotlin Multiplatform App CI/CD

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths-ignore: [ "**/*.md" ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4096m -XX:+HeapDumpOnOutOfMemoryError"
  APP_NAME: "Klyx"
  APP_VERSION: ${{ github.ref_type == 'tag' && github.ref_name || 'dev' }}

jobs:
  build-android-app:
    name: Build Android App
    runs-on: ubuntu-latest
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          docker system prune -af || true
          df -h

      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      - uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'

      - run: echo "${{ secrets.KLYX_KEYSTORE }}" | base64 -d > /tmp/klyx.keystore
      - run: echo "${{ secrets.KEYSTORE_PROP }}" | base64 -d > /tmp/sign.properties

      - uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      - run: chmod +x gradlew
      - name: Generate Tree-sitter grammar
        run: ./gradlew generateTsGrammar
      - name: Build Android APK
        env:
          CI: true
          CI_PROVIDER: github

          CI_WORKFLOW: ${{ github.workflow }}
          CI_JOB: ${{ github.job }}
          CI_RUN_ID: ${{ github.run_id }}
          CI_RUN_NUMBER: ${{ github.run_number }}
          CI_ATTEMPT: ${{ github.run_attempt }}
          CI_ACTOR: ${{ github.actor }}
          CI_EVENT: ${{ github.event_name }}

          GIT_COMMIT: ${{ github.sha }}
          GIT_BRANCH: ${{ github.ref_name }}
          GIT_REF: ${{ github.ref }}
          GIT_REF_TYPE: ${{ github.ref_type }}
          GIT_REPO: ${{ github.repository }}
          GIT_REPO_OWNER: ${{ github.repository_owner }}

          IS_PULL_REQUEST: ${{ github.event_name == 'pull_request' }}

          CI_OS: ${{ runner.os }}
          CI_ARCH: ${{ runner.arch }}

          ENABLE_STRICT_MODE: false
          ENABLE_EXPERIMENTAL: true
        run: |
          if ./gradlew tasks --all | grep -q "assembleRelease"; then
            ./gradlew assembleRelease
          else
            echo "Skipping Android build, task not available"
          fi
      - name: Move APK to root
        run: |
          mkdir -p klyx
          find . -path "*/build/outputs/apk/*/*.apk" -exec cp {} klyx/ \; 2>/dev/null || true

      - name: Upload arm64-v8a APK
        if: hashFiles('klyx/*arm64-v8a*.apk') != ''
        uses: actions/upload-artifact@v6
        with:
          name: apk-arm64-v8a
          path: klyx/*arm64-v8a*.apk
          retention-days: 15

      - name: Upload x86_64 APK
        if: hashFiles('klyx/*x86_64*.apk') != ''
        uses: actions/upload-artifact@v6
        with:
          name: apk-x86_64
          path: klyx/*x86_64*.apk
          retention-days: 15

      - name: Upload universal APK
        if: hashFiles('klyx/*universal*.apk') != ''
        uses: actions/upload-artifact@v6
        with:
          name: apk-universal
          path: klyx/*universal*.apk
          retention-days: 15
